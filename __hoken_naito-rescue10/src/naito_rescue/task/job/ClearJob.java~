package naito_rescue.task.job;

import rescuecore2.standard.components.*;
import rescuecore2.standard.entities.*;
import rescuecore2.worldmodel.*;
import naito_rescue.task.*;
import naito_rescue.agent.*;

import java.util.*;
import java.io.*;

/**
 * 道路啓開Job
 */
public class ClearJob extends Job
{
	Blockade target = null;
	Road     target_road;
	int      maxDistance;

	public ClearJob(NAITOHumanoidAgent owner, StandardWorldModel world, Blockade target, Road target_road, int maxDistance){
		super(owner, world);
		this.target = target;
		this.target_road = target_road;
	}
	public ClearJob(NAITOHumanoidAgent owner, StandardWorldModel world, int maxDistance){
		this(owner, world, null, null, maxDistance);
	}
	@Override
	public void doJob(){
		if(target != null){
			owner.clear(target.getID());
		}else if(owner.getLocation() instanceof Area){
			// target == nullの時
			// ownerが閉塞につかまってるとして，owner近辺を啓開する
			// まずowner.getLocation()が閉塞だったらそこを啓開する
			List<EntityID> ids = ((Area)owner.getLocation()).getBlockades();
			if(idx != null){
				for (EntityID next : ids) {
					Blockade b = (Blockade)model.getEntity(next);
					double d = owner.findDistanceTo(b, x, y);
					owner.getLogger().debug("Distance to " + b + " = " + d);
					if (maxDistance < 0 || d < maxDistance) {
						owner.getLogger().debug("In range");
						//啓開
						owner.clear(b.getID());
						return;
					}
				}
			}else{
				// owner.getLocation()がふつーの道だったら，その近辺を探索して啓開する
				for(EntityID neighbour : owner.getLocation().getNeighbours()){
					Area location = (Area)(owner.getWorldModel().getEntity(neighbour));
					Blockade b = location.getBlockades();
					if(b != null){
						double d = owner.findDistanceTo(b, x, y);
						if(maxDistance < 0 || d < maxDistance){
							//啓開
							owner.clear(b.getID());
							return;
						}
					}
				}
				//ここにパスが来るケース:
				//  . 啓開はあったが，啓開可能距離範囲内に存在しなかった
				//  . そもそも啓開がなかった
				return;
			}
		}else if(target != null){
			if(target_road.isBlockadesDefined()){
				List<EntityID> ids = target_road.getBlockades();
			}
		}else{
			getOwner().getLogger().info("ClearJob: target is null && !owner.getLocation() instanceof Area");
			return;
		}
	}

	@Override 
	protected boolean isFinished(NAITOHumanoidAgent owner, StandardWorldModel world){
		if(target_road != null){
			return !(target_road.isBlockadesDefined());
		}else{
			for(EntityID neighbour : owner.getLocation().getNeighbours()){
				Area location = (Area)(world.getEntity(neighbour));
				if(location.isBlockadesDefined()) return false;
			}
			return true;
		}
	}
}
